name: Build and push Docker image

on:
  push:
  workflow_dispatch:

env:
  CI: true
  DOCKER_BUILDKIT: 1

jobs:
  main:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        CPU_ARCH:
          - aarch64
          - x86_64
    steps:

    - name: Setup binfmt_misc
      if: (matrix.CPU_ARCH == 'aarch64') || (matrix.CPU_ARCH == 'arm')
      run: docker run --rm --privileged aptman/qus -s -- -p aarch64 arm

    - name: Build images
      run: |
        git clone https://github.com/yoimiya-kokomi/Miao-Yunzai.git -b master
        cd Miao-Yunzai
        case '${{ matrix.CPU_ARCH }}' in
          arm)     PLATFORM_TAG="linux/arm/v7";;
          aarch64) PLATFORM_TAG="linux/arm64";;
          *)       PLATFORM_TAG="linux/amd64";;
        esac
        sed -i "s/mirrors.ustc.edu.cn/deb.debian.org/g" ./docker/Dockerfile
        sed -i "s/pypi.tuna.tsinghua.edu.cn/pypi.org/g" ./docker/Dockerfile
        docker buildx build -t \
           ghcr.io/ikuaki1009/yunzai-docker-images:latest \
          --platform "$PLATFORM_TAG" \
          ./docker
    - name: Login to GHCR
      if: github.ref == 'refs/heads/main' && github.repository == 'ikuaki1009/yunzai-docker-images'
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Push
      if: github.ref == 'refs/heads/main' && github.repository == 'ikuaki1009/yunzai-docker-images'
      run: |
        docker push ghcr.io/ikuaki1009/yunzai-docker-images:latest
 
